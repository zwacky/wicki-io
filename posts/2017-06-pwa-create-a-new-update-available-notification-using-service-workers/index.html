<!DOCTYPE html>
<html><head>
  <title>PWA: Create a &#34;New Update Available&#34; Notification using Service Workers</title>
  <base href="/" />
  <link rel="preload" as="font" type="font/woff2" href="https://wicki.io/fonts/source-sans-pro-v14-latin-300.woff2" crossorigin />
  <link rel="preload" as="font" type="font/woff2" href="https://wicki.io/fonts/source-sans-pro-v14-latin-regular.woff2" crossorigin />
  <link rel="preload" as="font" type="font/woff2" href="https://wicki.io/fonts/playfair-display-v21-latin-regular.woff2" crossorigin />
  
  <link rel="stylesheet" href="/styles/main.min.css" integrity="" media="screen" />
  <link rel="canonical" href="https://wicki.io/posts/2017-06-pwa-create-a-new-update-available-notification-using-service-workers/" />
  <link rel="icon" type="image/x-icon" href="https://wicki.io/images/favicon.png" />
  
  <meta charset="utf-8" />
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=5" />
  <meta name="keywords" content="[PWA, service workers, offline-first, cache busting]" />

  <meta property="og:site_name" content="Wicki.io" />
  <meta property="og:title" content="PWA: Create a &#34;New Update Available&#34; Notification using Service Workers" name="title" />
  <meta property="og:description" content="Dive into the world of PWAs covering service workers, cache busting and offline-first." name="description" />
  <meta property="og:url" content="https://wicki.io/posts/2017-06-pwa-create-a-new-update-available-notification-using-service-workers/" />
  <meta property="og:image" content="https://wicki.io/posts/2017-06-pwa-create-a-new-update-available-notification-using-service-workers/new-update-available-popup.gif" />
  <meta property="og:type" content="article" />

  <meta name="author" content="Simon Wicki" />
  <meta name="twitter:site" content="@zwacky" />
  <meta name="twitter:creator" content="@zwacky" />
  <meta name="twitter:title" content="PWA: Create a &#34;New Update Available&#34; Notification using Service Workers"/>
  <meta name="twitter:description" content="Dive into the world of PWAs covering service workers, cache busting and offline-first."/>

  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#fff" />
</head>
<body><nav class="nav">
  <div class="container">
    <div class="nav__list">
      
      <a href="/" class="nav--brand" style="overflow: hidden;">
        <img src="images/logo.png" alt="W" width="38" />
      </a>
      <div>
        
        
        
        <a
          href="/posts"
          class="nav__list__item active"
          >Blog</a
        >
        <a
          class="d-none d-sm-inline nav__list__item nav__list__item--mail"
          href="mailto:simon@wicki.io"
          class="nav__list__item nav__list__item--mail"
        >
          Contact
        </a>
        <a
          class="d-inline d-sm-none nav__list__item nav__list__item--mail"
          href="mailto:simon@wicki.io"
        >
          <img
            src="/images/svg/envelope.svg"
            alt="Contact"
            title="Contact"
            style="height: 18px; position: relative; top: -2px;"
          />
        </a>
      </div>
    </div>
  </div>
</nav>
<div id="content">

<div class="container" style="padding-top: 180px;">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">
      <h1>PWA: Create a &#34;New Update Available&#34; Notification using Service Workers</h1>
      <div style="margin-bottom: 20px;">
        
          June 13, 2017
        
      </div>

      <figure>
    <img src="/posts/2017-06-pwa-create-a-new-update-available-notification-using-service-workers/new-update-available-popup.gif"
         alt="New Update available popup"/> <figcaption>
            <p>New Update available popup.</p>
        </figcaption>
</figure>

<p>PWAs are getting more and more coverage and support. They improve the web experience and can load your app instantly with their great ability for HTTP caching (among other things, but this post only covers caching).</p>
<p>The thing with Offline-First is, that you cache all the resources that are needed for launching up the webapp — even your index.html!</p>
<blockquote>
<p><strong>Note</strong>: No sweat! Browser implementations prevent you from deploying a version that will be cached for all eternity. For instance Chrome treats max-age of 1 day or 1 week or 1 year as 24 hours.</p>
</blockquote>
<h2 id="1-structure">#1 Structure</h2>
<p>For example reasons, the 3 needed files are linked to the source of an actual PWA (<a href="gamemusicplayer.io">gamemusicplayer.io</a>) for a clearer understanding.</p>
<ul>
<li><strong>index.html</strong> — registers the service-worker.js and is wrapped inside the isUpdateAvailable Promise</li>
<li><strong>service-worker.js</strong> — defines what files will be cached</li>
<li><strong>somewhere inside your webapp</strong> — listens to isUpdateAvailable Promise and acts accordingly</li>
</ul>
<h2 id="2-why-cant-it-just-load-the-latest-version">#2 Why can’t it just load the latest version?</h2>
<p>When the browser loads your PWA, it doesn’t know if there is a new version available. It promptly loads the cached assets. There are different cache strategies, depending on your use case.</p>
<ul>
<li><code>networkOnly</code> – only fetch from network</li>
<li><code>cacheOnly</code> – only fetch from cache</li>
<li><code>fastest</code> – fetch from both, and respond with whichever comes first</li>
<li><code>networkFirst</code> – fetch from network, if that fails, fetch from cache</li>
<li><code>cacheFirst</code> – fetch from cache, but also fetch from network and update cache</li>
</ul>
<p>In 99% of the cases you can decide on 2 user experiences:</p>
<ol>
<li>Load the page instantly from the cache</li>
<li>Check first if network is available, otherwise load from cache as a fallback</li>
</ol>
<p>Both options are offline-first. The 2nd option, if network is available, will therefore always deliver the most updated version, but with a delay.</p>
<p>If you want to give your users that ⚡️-fast page load experience and notify them when a newer version of their cached version is available, you’d need to hook into the onupdatefound function in your Service Worker.</p>
<h2 id="3-how-to-check-if-your-cached-files-have-changed">#3 How to check if your cached files have changed</h2>
<p>We can hook into onupdatefound function on the registered Service Worker. Even though you can cache tons of files, the Service Worker only checks the hash of your registered service-worker.js. If that file has only 1 little change in it, it will be treated as a new version.</p>
<h3 id="31-register-service-workerjs">#3.1 Register service-worker.js</h3>
<p>The following code should be inside <code>&lt;script&gt;</code> tags in your <strong>index.html</strong>. It will add a <code>isUpdateAvailable</code> function to the global scope, so it can later be used as a Promise.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// make the whole serviceworker process into a promise so later on we can
</span><span style="color:#75715e">// listen to it and in case new content is available a toast will be shown
</span><span style="color:#75715e"></span>window.<span style="color:#a6e22e">isUpdateAvailable</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) {
  <span style="color:#75715e">// lazy way of disabling service workers while developing
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (
    <span style="color:#e6db74">&#34;serviceWorker&#34;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">navigator</span> <span style="color:#f92672">&amp;&amp;</span>
    [<span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#e6db74">&#34;127&#34;</span>].<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">hostname</span>) <span style="color:#f92672">===</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
  ) {
    <span style="color:#75715e">// register service worker file
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">serviceWorker</span>
      .<span style="color:#a6e22e">register</span>(<span style="color:#e6db74">&#34;service-worker.js&#34;</span>)
      .<span style="color:#a6e22e">then</span>((<span style="color:#a6e22e">reg</span>) =&gt; {
        <span style="color:#a6e22e">reg</span>.<span style="color:#a6e22e">onupdatefound</span> <span style="color:#f92672">=</span> () =&gt; {
          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">installingWorker</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">reg</span>.<span style="color:#a6e22e">installing</span>;
          <span style="color:#a6e22e">installingWorker</span>.<span style="color:#a6e22e">onstatechange</span> <span style="color:#f92672">=</span> () =&gt; {
            <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">installingWorker</span>.<span style="color:#a6e22e">state</span>) {
              <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;installed&#34;</span><span style="color:#f92672">:</span>
                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">navigator</span>.<span style="color:#a6e22e">serviceWorker</span>.<span style="color:#a6e22e">controller</span>) {
                  <span style="color:#75715e">// new update available
</span><span style="color:#75715e"></span>                  <span style="color:#a6e22e">resolve</span>(<span style="color:#66d9ef">true</span>);
                } <span style="color:#66d9ef">else</span> {
                  <span style="color:#75715e">// no update available
</span><span style="color:#75715e"></span>                  <span style="color:#a6e22e">resolve</span>(<span style="color:#66d9ef">false</span>);
                }
                <span style="color:#66d9ef">break</span>;
            }
          };
        };
      })
      .<span style="color:#66d9ef">catch</span>((<span style="color:#a6e22e">err</span>) =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;[SW ERROR]&#34;</span>, <span style="color:#a6e22e">err</span>));
  }
});

<span style="color:#75715e">// Update:
</span><span style="color:#75715e">// this also can be incorporated right into e.g. your run() function in angular,
</span><span style="color:#75715e">// to avoid using the global namespace for such a thing.
</span><span style="color:#75715e">// because the registering of a service worker doesn&#39;t need to be executed on the first load of the page.
</span></code></pre></div><h3 id="32-check-if-update-is-available">#3.2 Check if update is available</h3>
<p>In this example i’m using <a href="http://ionicframework.com/">Ionic 3</a> to easily display a toast that will tell the user that there has been an update — in case of an update.</p>
<h2 id="4-caveats">#4 Caveats</h2>
<p>Problems can arise when you use a hosting service, that automatically adds <code>max-age</code> headers to your resources — especially your service-worker.js.</p>
<p>For instance if you host your PWA over <a href="https://firebase.google.com/docs/hosting/">Firebase Hosting</a>, you’ll find this configuration useful.</p>
<p>(Bonus: the public folder is set to <code>./platforms/browser/www/</code> because <a href="https://ionicframework.com/">Ionic 3</a> makes it very easy for PWAs from start to finish!)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;hosting&#34;</span>: {
    <span style="color:#f92672">&#34;public&#34;</span>: <span style="color:#e6db74">&#34;./platforms/browser/www/&#34;</span>,
    <span style="color:#f92672">&#34;rewrites&#34;</span>: [
      {
        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;**&#34;</span>,
        <span style="color:#f92672">&#34;destination&#34;</span>: <span style="color:#e6db74">&#34;/index.html&#34;</span>
      }
    ],
    <span style="color:#f92672">&#34;headers&#34;</span>: [
      {
        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;service-worker.js&#34;</span>,
        <span style="color:#f92672">&#34;headers&#34;</span>: [
          {
            <span style="color:#f92672">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;Cache-Control&#34;</span>,
            <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;max-age=0&#34;</span>
          }
        ]
      }
    ]
  }
}
</code></pre></div><h2 id="5-summary">#5 Summary</h2>
<p>Service Workers aren’t as scary as they seem at first. With the appropriate safety mechanisms in place (never cache more than 24 hours) you can create a great experience for your users without having to change your domain name.</p>


      
      <hr /><div class="about__bio">
  <div class="about__bio__profile">
    
    
    <img
      src="/images/me_huc890d15b6e9f2ce8978e9aa27127dd5e_67203_350x0_resize_q75_box.jpg"
      alt="Simon Wicki"
      class="about__bio__profile--image"
    />
    
  </div>

  <div>
    <div
      style="
        font-weight: 400;
        color: inherit;
        font-size: inherit;
        margin-top: 0;
        margin-bottom: 1rem;
      "
    >
      <p>
        <strong>Simon Wicki</strong> is a Freelance Frontend Developer in
				Berlin. Passionate and fluent in Vue, Angular, React and Ionic. Interested in 
				Tech, frontend & non-fiction books
      </p>
      <p>
        <a
          href="https://twitter.com/zwacky"
          onclick="ga('send', 'event', 'clickout', 'bottom_cta', '\/posts\/2017-06-pwa-create-a-new-update-available-notification-using-service-workers\/')"
          target="_blank"
          style="
            border-radius: 4px;
            padding: 4px 13px 4px 13px;
            background-color: #1b95e0;
            color: white;
            display: inline-block;
            border: 0;
            opacity: 1;
          "
        >
          <img
            src="images/svg/twitter.svg"
            alt="Twitter"
            title="Twitter"
            style="
              filter: brightness(10);
              margin-right: 4px;
              position: relative;
              bottom: 2px;
            "
          />
          Follow @zwacky
        </a>
      </p>
    </div>
  </div>
</div>

    </div>
  </div>
</div>


        </div><footer class="footer">
	<div class="container">
		<div style="display: flex; justify-content: space-between;">
			<div class="footer__shoutout">
				Made with Hugo and 
				<span style="white-space: nowrap;">
					
					
					<img src="/images/svg/heart.svg" alt="Love" style="opacity: 0.5; height: 16px;" />
				</span>
			</div>
			<div class="footer__links">
				<a href="/privacy">Privacy Policy</a>
				<a href="/imprint">Impressum</a>
			</div>
		</div>
	</div>
</footer>
<script type="application/javascript">
  window.ga =
    window.ga ||
    function () {
      (ga.q = ga.q || []).push(arguments);
    };
  ga.l = +new Date();
  ga("create", "UA-176737760-1", "auto");
  ga("set", "anonymizeIp", true);
  ga("set", "allowAdFeatures", false);
  ga("set", "allowAdPersonalizationSignals", false);
  ga("send", "pageview");
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


    </body>
</html>
