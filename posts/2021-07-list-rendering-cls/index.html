<!DOCTYPE html>
<html><head>
  <title>How List Rendering Can Cause Huge Cumulative Layout Shift</title>
  <base href="/" />
  <link rel="preload" as="font" type="font/woff2" href="https://wicki.io/fonts/source-sans-pro-v14-latin-300.woff2" crossorigin />
  <link rel="preload" as="font" type="font/woff2" href="https://wicki.io/fonts/source-sans-pro-v14-latin-regular.woff2" crossorigin />
  <link rel="preload" as="font" type="font/woff2" href="https://wicki.io/fonts/playfair-display-400-eef7b5853f.woff2" crossorigin />
  
  <link rel="stylesheet" href="/styles/main.min.css" integrity="" media="screen" />
  <link rel="canonical" href="https://wicki.io/posts/2021-07-list-rendering-cls/" />
  <link rel="icon" type="image/x-icon" href="https://wicki.io/images/favicon.png" />
  
  
  <link rel="feed" href="/posts/index.xml" type="application/rss+xml" title="Blog posts on Simon Wicki ‚Äî Frontend Engineer from Berlin">

  <meta charset="utf-8" />
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=5" />
  <meta name="keywords" content="[Core Web Vitals, SEO, webperf, Javascript]" />

  <meta property="og:site_name" content="Wicki.io" />
  <meta property="og:title" content="How List Rendering Can Cause Huge Cumulative Layout Shift" name="title" />
  <meta property="og:description" content="This post explains a hidden caveat of list rendering in JavaScript frameworks in term of CLS." name="description" />
  <meta property="og:url" content="https://wicki.io/posts/2021-07-list-rendering-cls/" />
  <meta property="og:image" content="https://wicki.io/posts/2021-07-list-rendering-cls/cls-slow-connection-devices.png" />
  <meta property="og:type" content="article" />

  <meta name="author" content="Simon Wicki" />
  <meta name="twitter:site" content="@zwacky" />
  <meta name="twitter:creator" content="@zwacky" />
  <meta name="twitter:title" content="How List Rendering Can Cause Huge Cumulative Layout Shift"/>
  <meta name="twitter:description" content="This post explains a hidden caveat of list rendering in JavaScript frameworks in term of CLS."/>

  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#fff" />
</head>
<body><nav class="nav">
  <div class="container">
    <div class="nav__list">
      
      <div style="display: flex; align-items: center;">
        <a href="/" class="nav--brand" style="overflow: hidden;">
          <img src="images/logo.png" alt="W" width="38" />
        </a>
      </div>
      <div>
        
        
        <a
          href="/posts"
          class="nav__list__item active"
          >Blog</a
        >
        
        <a href id="search_search" class="nav__list__item">
          <img
            src="/images/svg/search.svg"
            alt="Search"
            class="searchbar__icon"
            onclick="ga('send', 'event', 'search', 'toggle', 'on')"
          />
        </a>
        
        <div class="searchbar">
          <input id="search_input" type="text" name="q" placeholder="Search‚Ä¶" autocomplete="off">
          <a href id="search_close">
            <img
              src="/images/svg/close.svg"
              alt="close"
              class="searchbar__icon"
              style="height: 30px;"
            />
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="search-results" id="search_results">
    <div class="container"></div>
  </div>
</nav>
<div id="content">


<script type="text/javascript" src="/search.js" defer></script>

<div class="container" style="padding-top: 180px;">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">
      <h1>How List Rendering Can Cause Huge Cumulative Layout Shift</h1>
      <div style="margin-bottom: 20px;">
        
          <time datetime="2021-07-28 00:00:00 &#43;0000 UTC">July 28, 2021</time>
        
      </div>

      <p>Do you&hellip;</p>
<ul>
<li>care about Core Web Vitals, especially Cumulative Layout Shift (CLS)</li>
<li>use list rendering with a JS Framework (<code>v-for</code>, <code>*ngFor</code>, &hellip;)</li>
</ul>
<p>If you answered both with yes, then please read on.</p>
<figure>
    <img src="/posts/2021-07-list-rendering-cls/update-list-cls.gif"
         alt="Slow connection device causes 0.51 CLS upon updating a list."/> <figcaption>
            <p>Slow connection device causes 0.51 CLS upon updating a list.</p>
        </figcaption>
</figure>

<p>JS frameworks‚Äîsuch as Vue, Angular or React‚Äîcan cache DOM nodes of list items*. Filtering a list will therefore be faster, because DOM nodes of list items can potentially be reused. This reuse is done by moving the DOM nodes around, instead of re-creating them.</p>
<p>But when a list changes and the nodes of list items merely switch their positions, <strong>the reused items are considered as a shift in the DOM (CLS) by Core Web Vitals on slow connection devices</strong>.</p>
<p>*) Vue uses <code>:key</code>, React uses <code>key</code>, Angular uses <code>*ngFor</code> with <code>trackBy</code></p>
<hr>
<h1 id="why-only-on-slow-connection-devices">Why only on slow connection devices?</h1>
<p>CLS takes user interaction into account. When content is changing after a click, it&rsquo;s not counted towards the CLS until a grace period of 500ms. If the delay of content changing takes longer than 500ms, you&rsquo;ll be penalised with the full CLS score.</p>
<p>Fast connection devices will usually finish updating the list before the grace period ends.</p>
<p>Keep an eye out in your Google Search Console for URLs that are frequented by countries that are further away from your servers/CDNs and have a lower average mobile bandwidth.</p>
<figure>
    <img src="/posts/2021-07-list-rendering-cls/gsc-urls-affected-by-lower-bandwith.png"
         alt="A whopping 433k Indian URLs are affected here by list rendering on slow connection devices."/> <figcaption>
            <p>A whopping 433k Indian URLs are affected here by list rendering on slow connection devices.</p>
        </figcaption>
</figure>

<hr>
<h1 id="solution">Solution</h1>
<p>Google&rsquo;s calculation of CLS <a href="https://web.dev/evolving-cls/">has been changed before</a>, so I would love to see this here too. Until then it&rsquo;s on us to not get penalised.</p>
<p>We&rsquo;d have to make sure, that the DOM elements get re-created everytime a list gets updated or filtered. I wouldn&rsquo;t advise to completely drop the unique key (<code>:key</code>). Rather think of a key for each list item that is tied to the request itself, e.g. <code>:key=&quot;item.id + &quot;-&quot; + requestQuery&quot;</code>. The filtering itself will have a brief flash due to recreating the DOM node, but considering the Green URLs that Google will give you it&rsquo;s worth it.</p>
<p>With this you can continue with infinite scroll and page navigation without perf loss.</p>
<hr>
<p>If you found this post interesting please leave a ‚ù§Ô∏è on this tweet and consider following my üé¢ journey about #webperf, #buildinpublic and #frontend matters <a href="https://twitter.com/zwacky">on Twitter</a>.
<br /><br />
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">How can Cumulative Layout Shift (CLS) happen with a simple list rendering? üßÆ<br><br>See it in action in the gif:<br>A whopping 0.51 CLS was produced with a mobile viewport and mid-tier connection.<br><br>Read on to understand what it is and how you can make Google&#39;s Core Web Vitals happy. üëá <a href="https://t.co/nfC8nB7FQW">pic.twitter.com/nfC8nB7FQW</a></p>&mdash; Simon Wicki (@zwacky) <a href="https://twitter.com/zwacky/status/1420640015877607424?ref_src=twsrc%5Etfw">July 29, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</p>


	
	<link rel="stylesheet" href="/styles/post-series.min.css" integrity="" media="screen" />

	
	
	

	<div class="post-series">
		<div class="post-series__box">Optimising for Core Web Vitals (4 part series)</div>
		
			
			
			<div class="post-series__box__item">
				<a href="/posts/2021-07-core-web-vitals/" class="post-series__box__item ">
					<span class="post-series__box__item__index">1</span>
					<span>Core Web Vitals explained with GIFs</span>
				</a>
			</span>
			</div>
		
			
			
			<div class="post-series__box__item">
				<a href="/posts/2021-07-list-rendering-cls/" class="post-series__box__item active">
					<span class="post-series__box__item__index">2</span>
					<span>How List Rendering Can Cause Huge Cumulative Layout Shift</span>
				</a>
			</span>
			</div>
		
			
			
			<div class="post-series__box__item">
				<a href="/posts/2021-08-accurate-core-web-vitals-measurements/" class="post-series__box__item ">
					<span class="post-series__box__item__index">3</span>
					<span>Accurate Daily Measurements of Core Web Vitals with Google Analytics</span>
				</a>
			</span>
			</div>
		
			
			
			<div class="post-series__box__item">
				<a href="/posts/2022-03-hidden-cost-of-lazy-loading/" class="post-series__box__item ">
					<span class="post-series__box__item__index">4</span>
					<span>The Hidden Cost of Lazy Loading Components</span>
				</a>
			</span>
			</div>
		
	</div>

      <div style="border-top: 1px solid #e4e4f0; margin-top: 86px; margin-bottom: 50px;"></div><div class="about__bio">
  <div class="about__bio__profile">
    
    
    <img
      src="/images/me_huc890d15b6e9f2ce8978e9aa27127dd5e_67203_350x0_resize_q75_box.jpg"
      alt="Simon Wicki"
      class="about__bio__profile--image"
    />
    
  </div>

  <div>
    <div
      style="
        font-weight: 400;
        color: inherit;
        font-size: inherit;
        margin-top: 0;
        margin-bottom: 1rem;
      "
    >
      <p>
        <strong>Simon Wicki</strong> is a Freelance Developer in Berlin. Worked on Web and Mobile apps at
				JustWatch. Fluent in Vue, Angular, React and Ionic. Passionate about Frontend, tech, web perf &
				non-fiction books.
      </p>
      <p>
        <a
          href="https://twitter.com/zwacky"
          onclick="ga('send', 'event', 'clickout', 'bottom_cta', '\/posts\/2021-07-list-rendering-cls\/')"
          target="_blank"
          style="
            border-radius: 4px;
            padding: 4px 13px 4px 13px;
            background-color: #1b95e0;
            color: white;
            display: inline-block;
            border: 0;
            opacity: 1;
          "
        >
          <img
            src="images/svg/twitter.svg"
            alt="Twitter"
            title="Twitter"
            style="
              filter: brightness(10);
              margin-right: 4px;
              position: relative;
              bottom: 2px;
            "
          />
          Follow @zwacky
        </a>
      </p>
    </div>
  </div>
</div>

    </div>
  </div>
</div>


        </div><footer class="footer">
	<div class="container">
		<div style="display: flex; justify-content: space-between;">
			<div class="footer__shoutout">
				Made with Hugo and 
				<span style="white-space: nowrap;">
					
					
					<img src="/images/svg/heart.svg" alt="Love" style="opacity: 0.5; height: 16px;" />
				</span>
			</div>
			<div class="footer__links">
				<a href="mailto:simon@wicki.io">Contact</a>
				<a href="/privacy">Privacy Policy</a>
				<a href="/imprint">Impressum</a>
			</div>
		</div>
	</div>
</footer>
<script type="application/javascript">
  window.ga =
    window.ga ||
    function () {
      (ga.q = ga.q || []).push(arguments);
    };
  ga.l = +new Date();
  ga("create", "UA-176737760-1", "auto");
  ga("set", "anonymizeIp", true);
  ga("set", "allowAdFeatures", false);
  ga("set", "allowAdPersonalizationSignals", false);
  ga("send", "pageview");
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


    </body>
</html>
